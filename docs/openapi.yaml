openapi: 3.0.3
info:
  title: Pronunex API
  version: 1.0.0
  description: |
    API documentation for Pronunex, an AI-powered speech therapy platform.
    
    ## Overview
    The Pronunex API provides endpoints for user authentication, practicing pronunciation with real-time feedback, accessing a library of phonemes and sentences, and tracking progress over time.

    ## Authentication
    Most endpoints require authentication using JWT (JSON Web Tokens).
    1. Register or Login to get `access` and `refresh` tokens.
    2. Include the access token in the `Authorization` header: `Bearer <token>`.
    3. Use the refresh token to get a new access token when it expires.

servers:
  - url: http://localhost:8000/api/v1
    description: Local Development Server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- Auth & User ---
    User:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        username:
          type: string
        full_name:
          type: string
        native_language:
          type: string
        proficiency_level:
          type: string
          enum: [beginner, intermediate, advanced]
        is_email_verified:
          type: boolean
    
    TokenPair:
      type: object
      properties:
        access:
          type: string
        refresh:
          type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    SignupRequest:
      type: object
      required: [email, username, password, password_confirm]
      properties:
        email:
          type: string
          format: email
        username:
          type: string
        full_name:
          type: string
        password:
          type: string
          format: password
        password_confirm:
          type: string
          format: password
        native_language:
          type: string
        proficiency_level:
          type: string

    # --- Library ---
    Phoneme:
      type: object
      properties:
        id:
          type: integer
        symbol:
          type: string
        arpabet:
          type: string
        ipa:
          type: string
        type:
          type: string
          enum: [vowel, consonant]
        example_word:
          type: string
        description:
          type: string
        articulation_tip:
          type: string

    ReferenceSentenceList:
      type: object
      properties:
        id:
          type: integer
        text:
          type: string
        difficulty_level:
          type: string
        audio_source:
          type: string
          nullable: true
        target_phonemes:
          type: array
          items:
            type: string

    ReferenceSentenceDetail:
      allOf:
        - $ref: '#/components/schemas/ReferenceSentenceList'
        - type: object
          properties:
            phoneme_sequence:
              type: array
              items:
                type: string
            sentence_phonemes:
              type: array
              items:
                $ref: '#/components/schemas/SentencePhoneme'

    SentencePhoneme:
      type: object
      properties:
        phoneme:
          $ref: '#/components/schemas/Phoneme'
        position:
          type: integer
        word_context:
          type: string

    # --- Practice & Assessment ---
    Session:
      type: object
      properties:
        id:
          type: integer
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
          nullable: true
        overall_score:
          type: number
          nullable: true
        total_attempts:
          type: integer

    Attempt:
      type: object
      properties:
        id:
          type: integer
        sentence_text:
          type: string
        score:
          type: number
        fluency_score:
          type: number
          nullable: true
        created_at:
          type: string
          format: date-time

    AttemptDetail:
      allOf:
        - $ref: '#/components/schemas/Attempt'
        - type: object
          properties:
            llm_feedback:
              type: object
            phoneme_scores:
              type: array
              items:
                type: object
            weak_phonemes:
              type: array
              items:
                type: string
            phoneme_errors:
              type: array
              items:
                $ref: '#/components/schemas/PhonemeError'

    PhonemeError:
      type: object
      properties:
        phoneme_symbol:
          type: string
        similarity_score:
          type: number
        word_context:
          type: string
        is_weak:
          type: boolean

    AssessmentResult:
      type: object
      properties:
        overall_score:
          type: number
        fluency_score:
          type: number
        weak_phonemes:
          type: array
          items:
            type: string
        llm_feedback:
          type: object
        attempt_id:
          type: integer

    # --- Analytics ---
    ProgressDashboard:
      type: object
      properties:
        total_sessions:
          type: integer
        total_practice_minutes:
          type: number
        overall_average_score:
          type: number
        current_weak_phonemes:
          type: array
          items:
            type: string
        score_trend:
          type: string
          enum: [improving, stable, declining, insufficient_data]
        streak:
          type: object
          properties:
            current_streak:
              type: integer
            longest_streak:
              type: integer

    PhonemeProgress:
      type: object
      properties:
        phoneme_symbol:
          type: string
        current_score:
          type: number
        attempts_count:
          type: integer
        is_weak:
          type: boolean
        improvement_rate:
          type: number

paths:
  # --- Auth ---
  /auth/register/:
    post:
      tags: [Auth]
      summary: Register a new user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        201:
          description: Registration successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  tokens:
                    $ref: '#/components/schemas/TokenPair'

  /auth/login/:
    post:
      tags: [Auth]
      summary: Login user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        200:
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  tokens:
                    $ref: '#/components/schemas/TokenPair'

  /auth/profile/:
    get:
      tags: [Auth]
      summary: Get user profile
      responses:
        200:
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    put:
      tags: [Auth]
      summary: Update user profile
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        200:
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  # --- Library ---
  /library/phonemes/:
    get:
      tags: [Library]
      summary: List all phonemes
      parameters:
        - name: search
          in: query
          schema:
            type: string
      responses:
        200:
          description: List of phonemes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Phoneme'

  /library/phonemes/{id}/:
    get:
      tags: [Library]
      summary: Get phoneme details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Phoneme details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Phoneme'

  /library/sentences/:
    get:
      tags: [Library]
      summary: List practice sentences
      parameters:
        - name: difficulty_level
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
      responses:
        200:
          description: List of sentences
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReferenceSentenceList'

  /library/sentences/{id}/:
    get:
      tags: [Library]
      summary: Get sentence details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Sentence details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferenceSentenceDetail'

  /library/sentences/{id}/audio/:
    get:
      tags: [Library]
      summary: Get sentence audio
      description: Returns WAV audio file. Generates on-the-fly if missing.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Audio file
          content:
            audio/wav:
              schema:
                type: string
                format: binary

  /library/sentences/recommend/:
    get:
      tags: [Library]
      summary: Get recommended sentences
      description: Based on weak phonemes or general difficulty.
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 5
        - name: difficulty
          in: query
          schema:
            type: string
      responses:
        200:
          description: Recommendations
          content:
            application/json:
              schema:
                type: object
                properties:
                  recommendations:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReferenceSentenceList'
                  based_on_weak_phonemes:
                    type: array
                    items:
                      type: string

  # --- Practice ---
  /practice/sessions/:
    get:
      tags: [Practice]
      summary: List user sessions
      responses:
        200:
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Session'
    post:
      tags: [Practice]
      summary: Create new session
      responses:
        201:
          description: Created session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'

  /practice/sessions/{id}/end/:
    post:
      tags: [Practice]
      summary: End a session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Session ended
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  session:
                    $ref: '#/components/schemas/Session'

  /practice/assess/:
    post:
      tags: [Practice]
      summary: Assess pronunciation
      description: Upload audio blob to analyze pronunciation against a target sentence.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [audio, sentence_id]
              properties:
                audio:
                  type: string
                  format: binary
                sentence_id:
                  type: integer
      responses:
        200:
          description: Assessment result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssessmentResult'

  # --- Analytics ---
  /analytics/progress/:
    get:
      tags: [Analytics]
      summary: Get progress dashboard
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            default: 30
      responses:
        200:
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgressDashboard'

  /analytics/phoneme-stats/:
    get:
      tags: [Analytics]
      summary: Get phoneme statistics
      responses:
        200:
          description: Detailed phoneme stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  by_type:
                    type: object
                  weak_phonemes_detail:
                    type: array
                    items:
                      type: object
